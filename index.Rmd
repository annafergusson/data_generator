---
title: Data generator
output: 
  html_document:
    includes:
      in_header: header.html
---


```{css echo=FALSE}
/* Absolute Center Spinner */
.loading {
  z-index: 999;
  overflow: show;
  margin: auto;
  display: block;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0,0,0,0.3);
}


```

```{js echo=FALSE}
$().ready(function(){
  
  //----------------------------------------------------------------------------
    doStuff(); 
  //----------------------------------------------------------------------------
 
  // set interface
  var kAppName = "data generator";
  var kVersion = "1.0";
  var kDimensions = {width: 400, height: 400};
  
  codapInterface.init({
    title: kAppName,
    dimensions: kDimensions,
    version: kVersion,
    preventDataContextReorg: false,
  }).then(function (result) {
    myState = codapInterface.getInteractiveState();
  }).then(function () {
  // initialise tool
    if (myState.code === undefined || myState.code === null) {
      // do nothing
    }
    else
    {
  	  //use values saved in state to set options for the tool
      //editor.setValue(myState.code); 
      
    }
  }).catch(function (msg) {
    console.log(msg);
  });

function doStuff(){
  $(".CODAP").each(function() {
    //save current code - maybe should autosave?
    //var editor = ace.edit("tutorial-exercise-live-code-code-editor");
		//myState.code = editor.getValue();
		
		//process data table
    var JSONstring = '[{"x":"blue","y":10},{"x":"blue","y":12},{"x":"blue","y":11},{"x":"blue","y":10},{"x":"blue","y":8},{"x":"green","y":1},{"x":"green","y":2},{"x":"green","y":1},{"x":"green","y":1},{"x":"green","y":4}]';
    var dataframe = JSON.parse(JSONstring);
    var tableName = "data";
    var data = dataframe;
    var attributes = Object.keys(data[0]);
    var kAttributes = [];
    for(var i = 0; i < attributes.length; i++)
    {
      kAttributes.push({name: attributes[i]})
    }
    
    codapInterface.sendRequest({
        action:'get',
        resource: 'dataContext[' + tableName + ']'
      }).then(function(result){
        if (result && !result.success) {
          codapInterface.sendRequest({
      "action": "create",
      "resource": "dataContext",
      "values": {
        "name": tableName,
        "collections": [ {
          "name": tableName,
          "attrs": kAttributes
        }]
      }
    })
        } 
      }).then(function(){
      codapInterface.sendRequest({
      "action": "create",
      "resource": "dataContext[" + tableName + "].item",
       "values": data
    })
    }).then(function(){
       //guaranteeCaseTable(tableName)
       codapInterface.sendRequest({action: 'create', resource: 'component', values: {
            type: 'caseTable',
            dataContext: tableName
          }})
    })
});
}

// from example CODAP plugin
function guaranteeCaseTable(name) {
  return new Promise(function (resolve, reject) {
    codapInterface.sendRequest({
      action: 'get',
      resource: 'componentList'
    })
    .then (function (iResult) {
      if (iResult.success) {
        // look for a case table in the list of components.
        if (iResult.values && iResult.values.some(function (component) {
              return component.type === 'caseTable'
            })) {
          resolve(iResult);
        } else {
          codapInterface.sendRequest({action: 'create', resource: 'component', values: {
            type: 'caseTable',
            dataContext: name
          }}).then(function (result) {
            resolve(result);
          });
        }
      } else {
        reject('api error');
      }
    })
  });
}

});

```