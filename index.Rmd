---
title: Data generator
output: 
  html_document:
    includes:
      in_header: header.html
---

```{css echo=FALSE}
/* Absolute Center Spinner */
.loading {
  z-index: 999;
  overflow: show;
  margin: auto;
  display: block;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0,0,0,0.3);
}

.title {
  display: none;
}

tr {
  border-top: 1px black solid !important;
  border-bottom: 1px black solid !important;
}

td {
  padding: 5px 10px 5px 10px !important;
  text-align: center;
}

.shadey {background: #F0F0F0}
    
.sectiony {margin-top: 20px}
  
```

# {.tabset .tabset-pills}

## Data generator

<div class='sectiony spinnery'>
<table>
<tr><td class='shadey'>Outcome</td><td>🐱</td><td>🐶</td><td>➕</td></tr>
<tr><td class='shadey'>Probability (%)</td><td>80</td><td>20</td><td></td></tr>
</table>
</div>

<div class='sectiony spinnery'>
Spin 5 times
</div>

<div id='spinner-wrapper' style="position:relative;  width: 200px;
    height: 200px;" class='sectiony'>
<canvas id='spinner' style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
<canvas id='pointer' style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
</div>

<div class='sectiony' style='height:20px'>
<span id='outcome'></span>
</div>

<div class='sectiony'>
<p>Repeat 10 times</p>
<button onclick='startSim()'>Do stuff</button>
</div>

## About

<div class='sectiony'>
Stuff about project here
</div>

```{js echo=FALSE}
$().ready(function(){

  // set interface
  var kAppName = "data generator";
  var kVersion = "1.0";
  var kDimensions = {width: 400, height: 600};
  
  codapInterface.init({
    title: kAppName,
    dimensions: kDimensions,
    version: kVersion,
    preventDataContextReorg: false,
  }).then(function (result) {
    myState = codapInterface.getInteractiveState();
  }).then(function () {
  // initialise tool
    if (myState.code === undefined || myState.code === null) {
      // set up default
  
    }
    else
    {
  	  //use values saved in state to set options for the tool
      //editor.setValue(myState.code); 
      
    }
  }).catch(function (msg) {
    console.log(msg);
  });
  
  setupSpinner();
  super_data = [];

});

function setupSpinner(){
  var canvas = document.getElementById("spinner");
  var context = canvas.getContext("2d");
  canvas.width = $("#spinner-wrapper").width();
  canvas.height = $("#spinner-wrapper").width();
  
  context.fillStyle = "#F0F0F0";
  context.strokeStyle = "black";
  context.beginPath();
  context.arc(canvas.width/2, canvas.height/2, canvas.width*0.4, 0, 2 * Math.PI);
  context.closePath();
  context.fill();
  context.stroke();
  
  var startAngle = 0.75 * 2 * Math.PI;
  
  //show each sector/outcome
  context.beginPath();
  context.moveTo(canvas.width/2, canvas.height/2);
  context.arc(canvas.width/2, canvas.height/2, canvas.width*0.4, startAngle, startAngle + 0.8 * 2 * Math.PI);
  context.lineTo(canvas.width/2, canvas.height/2);
  context.closePath();
  context.stroke();
  
  //add text
  context.font = canvas.width * 0.1 + "px Arial";
  context.fillText("🐱", canvas.width*0.6, canvas.height*0.6);
  
  //last section doesn't need stroke - rest of space
  context.fillText("🐶", canvas.width*0.3, canvas.height*0.3);
  
  //draw pointer
  var canvas = document.getElementById("pointer");
  var context = canvas.getContext("2d");
  canvas.width = $("#spinner-wrapper").width();
  canvas.height = $("#spinner-wrapper").width();
  drawPointer(canvas, context, 0);
}

function startSim(){
  var num_trials = 10;
  makeSpin(1, num_trials);
}

function makeSpin(this_trial, num_trials){
  $("#outcome").text("");
  data = {};
  var total_spins = 5;
  nextSpin(1, total_spins, 0, this_trial, num_trials);
}

function nextSpin(this_spin, total_spins, starting_angle, this_trial, num_trials){
  var canvas = document.getElementById("pointer");
  var context = canvas.getContext("2d");
  var randAngle = Math.random()*2*Math.PI;
  var randProp = (randAngle) / (2*Math.PI);
  var randOutcome = "🐱";
  if(randProp > 0.8){
    randOutcome = "🐶";
  }
  spin(canvas, context, starting_angle, randAngle + 4*Math.PI, 0.1, randOutcome, this_spin, total_spins, this_trial, num_trials)
}

function spin(canvas, context, angle, max, speed, randOutcome, this_spin, total_spins, this_trial, num_trials){
  var wait = 10;
  
  if(angle < max)
  {
    drawPointer(canvas, context, angle);
    
    setTimeout(function(){
      spin(canvas, context, angle + speed, max, speed, randOutcome, this_spin, total_spins, this_trial, num_trials)
    }, wait)
  }
  else
  {
  //move if needed to max point
  setTimeout(function(){
      drawPointer(canvas, context, max)
    }, wait);
    
    
    $("#outcome").append(randOutcome);
    var var_name = "val" + this_spin;
    data[var_name] = randOutcome;
    
    if(this_spin < total_spins)
    {
      setTimeout(function(){nextSpin(this_spin + 1, total_spins, max % 2*Math.PI, this_trial, num_trials)}, wait*20)
    }
    else
    { 
      var combine = "";
      for(var i = 1; i <= total_spins; i++)
      {
        combine = combine + data["val" + i];
        if(i < total_spins){combine = combine + " "}
      }
      data["vals"] = combine;
      
      //get this later
      var outcomes = ["🐱","🐶"];
      for(var i = 0; i < outcomes.length; i++)
      {
        var count = 0;
        for(var j = 1; j <= total_spins; j++)
        {
          if(data["val" + j] == outcomes[i]){count += 1}
        }
         data["count(" + outcomes[i] + ")"] = count;
      }
      
     // alert(JSON.stringify(data));
      super_data.push(data);
      doStuff([data]); 
      if(this_trial < num_trials)
      {
        setTimeout(function(){makeSpin(this_trial + 1, num_trials)}, wait*40)
      }
      else
      {
        //doStuff(super_data); 
      }
    }
  }
}

function drawPointer(canvas, context, angle){
  context.clearRect(0, 0, canvas.width, canvas.height)
  context.lineWidth = canvas.width * 0.02;
  context.strokeStyle = "#666666";
  context.fillStyle = "#666666";
  
  //translate and rotate canvas------------
  var x = canvas.width/2;
  var y = canvas.height/2;
  context.save();
  context.translate(x, y);
  context.rotate(angle);	
  context.translate( -x, -y);
  //---------------------------------------
  context.beginPath();
  context.moveTo(canvas.width/2, canvas.height/2);
  context.lineTo(canvas.width/2, canvas.height*0.1);
  context.closePath();
  context.stroke();
  
  context.beginPath();
  context.arc(canvas.width/2, canvas.height/2, canvas.width*0.02, 0, 2 * Math.PI);
  context.closePath();
  context.fill();
  
  context.beginPath();
  context.moveTo(canvas.width/2,  canvas.height*0.07);
  context.lineTo(canvas.width/2 + 0.04*canvas.width, canvas.height*0.15);
  context.lineTo(canvas.width/2 - 0.04*canvas.width, canvas.height*0.15);
  context.lineTo(canvas.width/2,  canvas.height*0.07);
  context.closePath();
  context.fill();
  //--------------------------------
  context.restore();
  //-------------------------------
}

function doStuff(dataframe){

    //save current code - maybe should autosave?
    //var editor = ace.edit("tutorial-exercise-live-code-code-editor");
		//myState.code = editor.getValue();
 
    var tableName = "generated_data";
    var data = dataframe;
    var attributes = Object.keys(data[0]);
    var kAttributes = [];
    for(var i = 0; i < attributes.length; i++)
    {
      kAttributes.push({name: attributes[i]})
    }
    
    codapInterface.sendRequest({
        action:'get',
        resource: 'dataContext[' + tableName + ']'
      }).then(function(result){
        if (result && !result.success) {
          codapInterface.sendRequest({
      "action": "create",
      "resource": "dataContext",
      "values": {
        "name": tableName,
        "collections": [ {
          "name": tableName,
          "attrs": kAttributes
        }]
      }
    })
        } 
      }).then(function(){
      codapInterface.sendRequest({
      "action": "create",
      "resource": "dataContext[" + tableName + "].item",
       "values": data
    })
    }).then(function(){
       //guaranteeCaseTable(tableName)
       codapInterface.sendRequest({action: 'create', resource: 'component', values: {
            type: 'caseTable',
            dataContext: tableName
          }})
    })
}

// from example CODAP plugin
function guaranteeCaseTable(name) {
  return new Promise(function (resolve, reject) {
    codapInterface.sendRequest({
      action: 'get',
      resource: 'componentList'
    })
    .then (function (iResult) {
      if (iResult.success) {
        // look for a case table in the list of components.
        if (iResult.values && iResult.values.some(function (component) {
              return component.type === 'caseTable'
            })) {
          resolve(iResult);
        } else {
          codapInterface.sendRequest({action: 'create', resource: 'component', values: {
            type: 'caseTable',
            dataContext: name
          }}).then(function (result) {
            resolve(result);
          });
        }
      } else {
        reject('api error');
      }
    })
  });
}



```